# 詳細設計書

## 1. クラス設計

### 1.1 Domain Layer

#### 1.1.1 TaskRepositoryInterface

```php
<?php

namespace App\Domain\Task\Repositories;

use App\Models\Task;

interface TaskRepositoryInterface
{
    /**
     * タスク一覧を取得する
     *
     * @param bool $onlyDeleted 削除済みのみ取得（優先度: 高）
     * @param bool $withDeleted 削除済みを含めて取得（優先度: 低）
     * @return \Illuminate\Database\Eloquent\Collection
     *
     * 注意: onlyDeleted=true, withDeleted=true の場合、onlyDeletedが優先される
     */
    public function findAll(bool $onlyDeleted = false, bool $withDeleted = false);

    /**
     * フィルタ条件付きでタスク一覧を取得する（ページネーション対応）
     *
     * @param \App\Application\Task\DTOs\GetTasksDto $dto
     * @return \Illuminate\Contracts\Pagination\LengthAwarePaginator
     */
    public function findAllWithFilter(\App\Application\Task\DTOs\GetTasksDto $dto);

    /**
     * タスクを作成する
     *
     * @param array $data
     * @return Task
     */
    public function create(array $data): Task;

    /**
     * IDでタスクを取得する
     *
     * @param int $id
     * @return Task|null
     */
    public function findById(int $id): ?Task;

    /**
     * タスクを更新する
     *
     * @param Task $task
     * @param array $data
     * @return Task
     */
    public function update(Task $task, array $data): Task;

    /**
     * タスクを削除する（論理削除）
     *
     * @param Task $task
     * @return bool
     */
    public function delete(Task $task): bool;

    /**
     * 削除されたタスクをIDで取得する
     *
     * @param int $id
     * @return Task|null
     */
    public function findDeletedById(int $id): ?Task;

    /**
     * タスクを復元する
     *
     * @param Task $task
     * @return bool
     */
    public function restore(Task $task): bool;
}
```

### 1.2 Application Layer

#### 1.2.1 DTOs

##### GetTasksDto

```php
<?php

namespace App\Application\Task\DTOs;

class GetTasksDto
{
    public function __construct(
        public readonly bool $onlyDeleted = false,
        public readonly bool $withDeleted = false,
        public readonly ?int $status = null,
        public readonly ?int $userId = null,
        public readonly ?string $keyword = null,
        public readonly ?string $dueDateFrom = null,
        public readonly ?string $dueDateTo = null,
        public readonly string $sortBy = 'created_at',
        public readonly string $sortDirection = 'desc',
        public readonly int $page = 1,
        public readonly int $perPage = 10
    ) {}

    public static function fromArray(array $data): self
    {
        return new self(
            onlyDeleted: self::toBool($data['only_deleted'] ?? false),
            withDeleted: self::toBool($data['with_deleted'] ?? false),
            status: isset($data['status']) ? (int) $data['status'] : null,
            userId: isset($data['user_id']) ? (int) $data['user_id'] : null,
            keyword: $data['keyword'] ?? null,
            dueDateFrom: $data['due_date_from'] ?? null,
            dueDateTo: $data['due_date_to'] ?? null,
            sortBy: $data['sort_by'] ?? 'created_at',
            sortDirection: $data['sort_direction'] ?? 'desc',
            page: isset($data['page']) ? (int) $data['page'] : 1,
            perPage: isset($data['per_page']) ? (int) $data['per_page'] : 10
        );
    }

    private static function toBool(mixed $value): bool
    {
        if (is_bool($value)) {
            return $value;
        }

        if (is_string($value)) {
            return $value === '1' || strtolower($value) === 'true';
        }

        return false;
    }
}
```

##### CreateTaskDto

```php
<?php

namespace App\Application\Task\DTOs;

class CreateTaskDto
{
    public function __construct(
        public readonly int $userId,
        public readonly string $title,
        public readonly ?string $description,
        public readonly int $status,
        public readonly ?string $dueDate,
        public readonly ?int $createdBy = null,
        public readonly ?int $updatedBy = null
    ) {}

    public static function fromArray(array $data): self
    {
        return new self(
            userId: (int) $data['user_id'],
            title: $data['title'],
            description: $data['description'] ?? null,
            status: (int) $data['status'],
            dueDate: $data['due_date'] ?? null,
            createdBy: isset($data['created_by']) ? (int) $data['created_by'] : null,
            updatedBy: isset($data['updated_by']) ? (int) $data['updated_by'] : null
        );
    }

    public function toArray(): array
    {
        return [
            'user_id' => $this->userId,
            'title' => $this->title,
            'description' => $this->description,
            'status' => $this->status,
            'due_date' => $this->dueDate,
            'created_by' => $this->createdBy,
            'updated_by' => $this->updatedBy,
        ];
    }
}
```

#### 1.2.2 Use Cases

##### GetTasksUseCase

```php
<?php

namespace App\Application\Task\UseCases;

use App\Application\Task\DTOs\GetTasksDto;
use App\Domain\Task\Repositories\TaskRepositoryInterface;
use Illuminate\Contracts\Pagination\LengthAwarePaginator;

class GetTasksUseCase
{
    public function __construct(
        private TaskRepositoryInterface $taskRepository
    ) {}

    /**
     * フィルタ条件に基づいてタスク一覧を取得する
     *
     * @param GetTasksDto $dto
     * @return LengthAwarePaginator
     */
    public function execute(GetTasksDto $dto): LengthAwarePaginator
    {
        return $this->taskRepository->findAllWithFilter($dto);
    }
}
```

##### CreateTaskUseCase

```php
<?php

namespace App\Application\Task\UseCases;

use App\Application\Task\DTOs\CreateTaskDto;
use App\Domain\Task\Repositories\TaskRepositoryInterface;
use App\Models\Task;
use Carbon\Carbon;

class CreateTaskUseCase
{
    public function __construct(
        private TaskRepositoryInterface $taskRepository
    ) {}

    /**
     * 新しいタスクを作成する
     *
     * @param CreateTaskDto $dto
     * @return Task
     */
    public function execute(CreateTaskDto $dto): Task
    {
        $data = $dto->toArray();

        // ステータスが完了の場合は完了日時を設定
        if ($dto->status === Task::STATUS_COMPLETED) {
            $data['completed_at'] = Carbon::now();
        }

        return $this->taskRepository->create($data);
    }
}
```

### 1.3 Infrastructure Layer

#### 1.3.1 EloquentTaskRepository

```php
<?php

namespace App\Infrastructure\Task\Repositories;

use App\Application\Task\DTOs\GetTasksDto;
use App\Domain\Task\Repositories\TaskRepositoryInterface;
use App\Models\Task;
use Illuminate\Contracts\Pagination\LengthAwarePaginator;

class EloquentTaskRepository implements TaskRepositoryInterface
{
    /**
     * タスク一覧を取得する
     */
    public function findAll(bool $onlyDeleted = false, bool $withDeleted = false)
    {
        $query = Task::query();

        if ($onlyDeleted) {
            $query->onlyTrashed();
        } elseif ($withDeleted) {
            $query->withTrashed();
        }

        return $query->get();
    }

    /**
     * フィルタ条件付きでタスク一覧を取得する（ページネーション対応）
     */
    public function findAllWithFilter(GetTasksDto $dto): LengthAwarePaginator
    {
        $query = Task::query();

        // 削除状態のフィルタ
        if ($dto->onlyDeleted) {
            $query->onlyTrashed();
        } elseif ($dto->withDeleted) {
            $query->withTrashed();
        }

        // ステータスフィルタ
        if ($dto->status !== null) {
            $query->where('status', $dto->status);
        }

        // ユーザーIDフィルタ
        if ($dto->userId !== null) {
            $query->where('user_id', $dto->userId);
        }

        // キーワード検索（タイトルまたは説明）
        if ($dto->keyword !== null && $dto->keyword !== '') {
            $query->where(function ($q) use ($dto) {
                $q->where('title', 'like', '%' . $dto->keyword . '%')
                  ->orWhere('description', 'like', '%' . $dto->keyword . '%');
            });
        }

        // 期限日の範囲フィルタ
        if ($dto->dueDateFrom !== null) {
            $query->where('due_date', '>=', $dto->dueDateFrom);
        }
        if ($dto->dueDateTo !== null) {
            $query->where('due_date', '<=', $dto->dueDateTo);
        }

        // 並び順
        $allowedSortColumns = ['id', 'title', 'status', 'due_date', 'created_at', 'updated_at'];
        $sortBy = in_array($dto->sortBy, $allowedSortColumns) ? $dto->sortBy : 'created_at';
        $query->orderBy($sortBy, $dto->sortDirection);

        // ページネーション
        return $query->paginate($dto->perPage, ['*'], 'page', $dto->page);
    }

    /**
     * タスクを作成する
     */
    public function create(array $data): Task
    {
        return Task::create($data);
    }

    /**
     * IDでタスクを取得する
     */
    public function findById(int $id): ?Task
    {
        return Task::withTrashed()->find($id);
    }

    /**
     * タスクを更新する
     */
    public function update(Task $task, array $data): Task
    {
        $task->update($data);
        return $task;
    }

    /**
     * タスクを削除する（論理削除）
     */
    public function delete(Task $task): bool
    {
        return $task->delete();
    }

    /**
     * 削除されたタスクをIDで取得する
     */
    public function findDeletedById(int $id): ?Task
    {
        return Task::onlyTrashed()->find($id);
    }

    /**
     * タスクを復元する
     */
    public function restore(Task $task): bool
    {
        return $task->restore();
    }
}
```

### 1.4 Presentation Layer

#### 1.4.1 TaskController

```php
<?php

namespace App\Http\Controllers\Api;

use App\Application\Task\DTOs\CreateTaskDto;
use App\Application\Task\DTOs\GetTasksDto;
use App\Application\Task\DTOs\UpdateTaskDto;
use App\Application\Task\DTOs\GetTaskDto;
use App\Application\Task\DTOs\DeleteTaskDto;
use App\Application\Task\DTOs\CompleteTaskDto;
use App\Application\Task\DTOs\RestoreTaskDto;
use App\Application\Task\UseCases\CreateTaskUseCase;
use App\Application\Task\UseCases\GetTaskUseCase;
use App\Application\Task\UseCases\GetTasksUseCase;
use App\Application\Task\UseCases\UpdateTaskUseCase;
use App\Application\Task\UseCases\DeleteTaskUseCase;
use App\Application\Task\UseCases\CompleteTaskUseCase;
use App\Application\Task\UseCases\RestoreTaskUseCase;
use App\Http\Requests\TaskStoreRequest;
use App\Http\Requests\TaskUpdateRequest;
use App\Models\Task;
use Illuminate\Http\JsonResponse;
use Illuminate\Http\Request;

class TaskController extends Controller
{
    public function __construct(
        private GetTasksUseCase $getTasksUseCase,
        private GetTaskUseCase $getTaskUseCase,
        private CreateTaskUseCase $createTaskUseCase,
        private UpdateTaskUseCase $updateTaskUseCase,
        private DeleteTaskUseCase $deleteTaskUseCase,
        private CompleteTaskUseCase $completeTaskUseCase,
        private RestoreTaskUseCase $restoreTaskUseCase
    ) {}

    /**
     * タスク一覧を取得する
     */
    public function index(Request $request): JsonResponse
    {
        try {
            $dto = GetTasksDto::fromArray($request->all());
            $tasks = $this->getTasksUseCase->execute($dto);

            return response()->json([
                'success' => true,
                'data' => $tasks
            ]);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => $e->getMessage()
            ], 400);
        }
    }

    /**
     * タスクを作成する
     */
    public function store(TaskStoreRequest $request): JsonResponse
    {
        try {
            $dto = CreateTaskDto::fromArray($request->validated());
            $task = $this->createTaskUseCase->execute($dto);

            return response()->json([
                'success' => true,
                'data' => $task
            ], 201);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => $e->getMessage()
            ], 400);
        }
    }

    /**
     * タスク詳細を取得する
     */
    public function show(Request $request): JsonResponse
    {
        try {
            $dto = GetTaskDto::fromArray($request->all());
            $task = $this->getTaskUseCase->execute($dto);

            if (!$task) {
                return response()->json([
                    'success' => false,
                    'message' => 'タスクが見つかりません'
                ], 404);
            }

            return response()->json([
                'success' => true,
                'data' => $task
            ]);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => $e->getMessage()
            ], 400);
        }
    }

    /**
     * タスクを更新する
     */
    public function update(TaskUpdateRequest $request): JsonResponse
    {
        try {
            $dto = UpdateTaskDto::fromArray($request->validated());
            $task = $this->updateTaskUseCase->execute($dto);

            return response()->json([
                'success' => true,
                'data' => $task
            ]);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => $e->getMessage()
            ], 400);
        }
    }

    /**
     * タスクを削除する
     */
    public function destroy(Request $request): JsonResponse
    {
        try {
            $dto = DeleteTaskDto::fromArray($request->all());
            $result = $this->deleteTaskUseCase->execute($dto);

            if (!$result) {
                return response()->json([
                    'success' => false,
                    'message' => 'タスクが見つかりません'
                ], 404);
            }

            return response()->json([
                'success' => true,
                'message' => 'タスクを削除しました'
            ]);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => $e->getMessage()
            ], 400);
        }
    }

    /**
     * タスクを完了にする
     */
    public function complete(Request $request): JsonResponse
    {
        try {
            $dto = CompleteTaskDto::fromArray($request->all());
            $task = $this->completeTaskUseCase->execute($dto);

            if (!$task) {
                return response()->json([
                    'success' => false,
                    'message' => 'タスクが見つかりません'
                ], 404);
            }

            return response()->json([
                'success' => true,
                'data' => $task
            ]);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => $e->getMessage()
            ], 400);
        }
    }

    /**
     * タスクを復元する
     */
    public function restore(Request $request): JsonResponse
    {
        try {
            $dto = RestoreTaskDto::fromArray($request->all());
            $task = $this->restoreTaskUseCase->execute($dto);

            if (!$task) {
                return response()->json([
                    'success' => false,
                    'message' => 'タスクが見つかりません'
                ], 404);
            }

            return response()->json([
                'success' => true,
                'data' => $task
            ]);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => $e->getMessage()
            ], 400);
        }
    }
}
```

## 2. データベースマイグレーション

### 2.1 users テーブル作成

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('users', function (Blueprint $table) {
            $table->id();
            $table->string('name');
            $table->string('email')->unique();
            $table->timestamp('email_verified_at')->nullable();
            $table->string('password');
            $table->rememberToken();
            $table->timestamps();
            $table->softDeletes();
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('users');
    }
};
```

### 2.2 tasks テーブル作成

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('tasks', function (Blueprint $table) {
            $table->id();
            $table->foreignId('user_id')->constrained()->onDelete('cascade');
            $table->string('title');
            $table->text('description')->nullable();
            $table->tinyInteger('status')->default(0);
            $table->dateTime('due_date')->nullable();
            $table->dateTime('completed_at')->nullable();
            $table->foreignId('created_by')->nullable()->constrained('users');
            $table->foreignId('updated_by')->nullable()->constrained('users');
            $table->timestamps();
            $table->softDeletes();
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('tasks');
    }
};
```

## 3. テスト設計

### 3.1 単体テスト

#### 3.1.1 DTO テスト

```php
<?php

namespace Tests\Unit\Application\Task\DTOs;

use App\Application\Task\DTOs\GetTasksDto;
use PHPUnit\Framework\TestCase;

class GetTasksDtoTest extends TestCase
{
    /**
     * デフォルト値でDTOが正しく作成されることをテスト
     */
    public function test_creates_dto_with_default_values(): void
    {
        $dto = GetTasksDto::fromArray([]);

        $this->assertFalse($dto->onlyDeleted);
        $this->assertFalse($dto->withDeleted);
        $this->assertNull($dto->status);
        $this->assertNull($dto->userId);
        $this->assertNull($dto->keyword);
        $this->assertEquals('created_at', $dto->sortBy);
        $this->assertEquals('desc', $dto->sortDirection);
        $this->assertEquals(1, $dto->page);
        $this->assertEquals(10, $dto->perPage);
    }

    /**
     * only_deletedパラメータが正しく処理されることをテスト
     */
    public function test_processes_only_deleted_parameter(): void
    {
        $dto = GetTasksDto::fromArray(['only_deleted' => true]);
        $this->assertTrue($dto->onlyDeleted);

        $dto = GetTasksDto::fromArray(['only_deleted' => false]);
        $this->assertFalse($dto->onlyDeleted);
    }

    /**
     * with_deletedパラメータが正しく処理されることをテスト
     */
    public function test_processes_with_deleted_parameter(): void
    {
        $dto = GetTasksDto::fromArray(['with_deleted' => true]);
        $this->assertTrue($dto->withDeleted);

        $dto = GetTasksDto::fromArray(['with_deleted' => false]);
        $this->assertFalse($dto->withDeleted);
    }
}
```

#### 3.1.2 UseCase テスト

```php
<?php

namespace Tests\Unit\Application\Task\UseCases;

use App\Application\Task\DTOs\GetTasksDto;
use App\Application\Task\UseCases\GetTasksUseCase;
use App\Domain\Task\Repositories\TaskRepositoryInterface;
use Illuminate\Contracts\Pagination\LengthAwarePaginator;
use Mockery;
use PHPUnit\Framework\TestCase;

class GetTasksUseCaseTest extends TestCase
{
    /**
     * UseCaseがRepositoryを正しく呼び出すことをテスト
     */
    public function test_execute_calls_repository_with_correct_dto(): void
    {
        // Arrange: モックとDTOを準備
        $mockRepository = Mockery::mock(TaskRepositoryInterface::class);
        $dto = new GetTasksDto();
        $expectedResult = Mockery::mock(LengthAwarePaginator::class);

        // Act: Repositoryの期待値を設定
        $mockRepository->shouldReceive('findAllWithFilter')
            ->once()
            ->with($dto)
            ->andReturn($expectedResult);

        $useCase = new GetTasksUseCase($mockRepository);

        // Act: UseCaseを実行
        $result = $useCase->execute($dto);

        // Assert: 結果を検証
        $this->assertSame($expectedResult, $result);
    }
}
```

### 3.2 統合テスト

#### 3.2.1 Repository テスト

```php
<?php

namespace Tests\Unit\Infrastructure\Task\Repositories;

use App\Infrastructure\Task\Repositories\EloquentTaskRepository;
use App\Models\Task;
use App\Models\User;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Tests\TestCase;

class EloquentTaskRepositoryTest extends TestCase
{
    use RefreshDatabase;

    /**
     * アクティブなタスクのみが取得されることをテスト
     */
    public function test_find_all_returns_only_active_tasks(): void
    {
        // Arrange: テストデータを作成
        $user = User::factory()->create();
        $activeTask = Task::factory()->create(['user_id' => $user->id]);
        $deletedTask = Task::factory()->create(['user_id' => $user->id]);
        $deletedTask->delete();

        $repository = new EloquentTaskRepository();

        // Act: アクティブなタスクのみを取得
        $result = $repository->findAll();

        // Assert: 結果を検証
        $this->assertCount(1, $result);
        $this->assertEquals($activeTask->id, $result->first()->id);
    }

    /**
     * 削除済みタスクのみが取得されることをテスト
     */
    public function test_find_all_with_only_deleted_returns_deleted_tasks(): void
    {
        // Arrange: テストデータを作成
        $user = User::factory()->create();
        $activeTask = Task::factory()->create(['user_id' => $user->id]);
        $deletedTask = Task::factory()->create(['user_id' => $user->id]);
        $deletedTask->delete();

        $repository = new EloquentTaskRepository();

        // Act: 削除済みタスクのみを取得
        $result = $repository->findAll(onlyDeleted: true);

        // Assert: 結果を検証
        $this->assertCount(1, $result);
        $this->assertEquals($deletedTask->id, $result->first()->id);
    }
}
```

### 3.3 機能テスト

#### 3.3.1 Controller テスト

```php
<?php

namespace Tests\Feature\Http\Controllers\Api;

use App\Models\Task;
use App\Models\User;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Tests\TestCase;

class TaskControllerIndexTest extends TestCase
{
    use RefreshDatabase;

    /**
     * タスク一覧が正常に取得されることをテスト
     */
    public function test_index_returns_successful_response(): void
    {
        // Arrange: テストデータを作成
        $user = User::factory()->create();
        $task = Task::factory()->create(['user_id' => $user->id]);

        // Act: APIを呼び出し
        $response = $this->getJson('/api/tasks');

        // Assert: レスポンスを検証
        $response->assertStatus(200)
            ->assertJson([
                'success' => true,
                'data' => [
                    'data' => [
                        [
                            'id' => $task->id,
                            'title' => $task->title,
                            'status' => 'pending'
                        ]
                    ]
                ]
            ]);
    }

    /**
     * 削除済みタスクのみが取得されることをテスト
     */
    public function test_index_with_only_deleted_returns_deleted_tasks(): void
    {
        // Arrange: テストデータを作成
        $user = User::factory()->create();
        $activeTask = Task::factory()->create(['user_id' => $user->id]);
        $deletedTask = Task::factory()->create(['user_id' => $user->id]);
        $deletedTask->delete();

        // Act: 削除済みタスクのみを取得
        $response = $this->getJson('/api/tasks?only_deleted=1');

        // Assert: レスポンスを検証
        $response->assertStatus(200);
        $data = $response->json('data.data');
        $this->assertCount(1, $data);
        $this->assertEquals($deletedTask->id, $data[0]['id']);
    }
}
```

## 4. 設定ファイル

### 4.1 サービスプロバイダー

```php
<?php

namespace App\Providers;

use App\Domain\Task\Repositories\TaskRepositoryInterface;
use App\Infrastructure\Task\Repositories\EloquentTaskRepository;
use Illuminate\Support\ServiceProvider;

class RepositoryServiceProvider extends ServiceProvider
{
    /**
     * Register services.
     */
    public function register(): void
    {
        $this->app->bind(
            TaskRepositoryInterface::class,
            EloquentTaskRepository::class
        );
    }

    /**
     * Bootstrap services.
     */
    public function boot(): void
    {
        //
    }
}
```

### 4.2 ルート定義

```php
<?php

use App\Http\Controllers\Api\AuthController;
use App\Http\Controllers\Api\TaskController;
use App\Http\Controllers\Api\UserController;
use Illuminate\Support\Facades\Route;

Route::prefix('api')->group(function () {
    // 認証ルート
    Route::prefix('auth')->group(function () {
        Route::post('register', [AuthController::class, 'register']);
        Route::post('login', [AuthController::class, 'login']);
        Route::post('logout', [AuthController::class, 'logout'])->middleware('auth:sanctum');
    });

    // 認証が必要なルート
    Route::middleware('auth:sanctum')->group(function () {
        // ユーザー管理
        Route::apiResource('users', UserController::class);

        // タスク管理
        Route::apiResource('tasks', TaskController::class);
        Route::post('tasks/{id}/complete', [TaskController::class, 'complete']);
        Route::post('tasks/{id}/restore', [TaskController::class, 'restore']);
    });
});
```

## 5. デプロイ設定

### 5.1 Docker 設定

```dockerfile
FROM php:8.2-fpm

# 必要なパッケージをインストール
RUN apt-get update && apt-get install -y \
    git \
    curl \
    libpng-dev \
    libonig-dev \
    libxml2-dev \
    zip \
    unzip

# PHP拡張をインストール
RUN docker-php-ext-install pdo_mysql mbstring exif pcntl bcmath gd

# Composerをインストール
COPY --from=composer:latest /usr/bin/composer /usr/bin/composer

# アプリケーションディレクトリを設定
WORKDIR /var/www

# アプリケーションファイルをコピー
COPY . .

# 依存関係をインストール
RUN composer install --no-dev --optimize-autoloader

# 権限を設定
RUN chown -R www-data:www-data /var/www
RUN chmod -R 755 /var/www/storage

EXPOSE 9000
CMD ["php-fpm"]
```

### 5.2 GitHub Actions 設定

```yaml
name: Tests

on:
    pull_request:
        types: [opened, synchronize]
        branches: [main, develop]

jobs:
    test:
        runs-on: ubuntu-latest

        strategy:
            matrix:
                php-version: [8.2]

        steps:
            - uses: actions/checkout@v3

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: ${{ matrix.php-version }}
                  extensions: mbstring, dom, fileinfo, mysql
                  coverage: xdebug

            - name: Copy .env
              run: php -r "file_exists('.env') || copy('.env.example', '.env');"

            - name: Install Dependencies
              run: composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist

            - name: Generate key
              run: php artisan key:generate

            - name: Directory Permissions
              run: chmod -R 777 storage bootstrap/cache

            - name: Create Database
              run: |
                  mkdir -p database
                  touch database/database.sqlite

            - name: Execute tests (Unit and Feature tests) via PHPUnit
              run: vendor/bin/phpunit --coverage-clover coverage.xml

            - name: Upload coverage to Codecov
              uses: codecov/codecov-action@v3
              with:
                  file: ./coverage.xml
                  flags: unittests
                  name: codecov-umbrella
```
