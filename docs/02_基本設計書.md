# 基本設計書

## 1. システム概要

### 1.1 システム構成

Clean Architecture パターンに基づくタスク管理システム

### 1.2 アーキテクチャ概要

```
┌─────────────────────────────────────────────────────────────┐
│                    Presentation Layer                        │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐ │
│  │   Controllers    │  │   Middleware    │  │   Routes     │ │
│  └─────────────────┘  └─────────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                    Application Layer                         │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐ │
│  │   Use Cases      │  │      DTOs       │  │  Services   │ │
│  └─────────────────┘  └─────────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                      Domain Layer                           │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐ │
│  │   Entities       │  │  Value Objects  │  │ Interfaces  │ │
│  └─────────────────┘  └─────────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                  Infrastructure Layer                       │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐ │
│  │  Repositories   │  │   Database      │  │  External   │ │
│  └─────────────────┘  └─────────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 2. データベース設計

### 2.1 ER 図

```
┌─────────────┐     ┌─────────────┐
│    Users    │     │    Tasks    │
├─────────────┤     ├─────────────┤
│ id (PK)     │────→│ id (PK)     │
│ name        │     │ user_id (FK)│
│ email       │     │ title       │
│ password    │     │ description │
│ created_at  │     │ status      │
│ updated_at  │     │ due_date    │
│ deleted_at  │     │ completed_at│
└─────────────┘     │ created_by  │
                    │ updated_by  │
                    │ created_at  │
                    │ updated_at  │
                    │ deleted_at  │
                    └─────────────┘
```

### 2.2 テーブル定義

#### 2.2.1 users テーブル

| カラム名   | データ型     | 制約                        | 説明                       |
| ---------- | ------------ | --------------------------- | -------------------------- |
| id         | BIGINT       | PRIMARY KEY, AUTO_INCREMENT | ユーザー ID                |
| name       | VARCHAR(255) | NOT NULL                    | ユーザー名                 |
| email      | VARCHAR(255) | UNIQUE, NOT NULL            | メールアドレス             |
| password   | VARCHAR(255) | NOT NULL                    | パスワード（ハッシュ化）   |
| created_at | TIMESTAMP    | NULL                        | 作成日時                   |
| updated_at | TIMESTAMP    | NULL                        | 更新日時                   |
| deleted_at | TIMESTAMP    | NULL                        | 削除日時（ソフトデリート） |

#### 2.2.2 tasks テーブル

| カラム名     | データ型     | 制約                        | 説明                                   |
| ------------ | ------------ | --------------------------- | -------------------------------------- |
| id           | BIGINT       | PRIMARY KEY, AUTO_INCREMENT | タスク ID                              |
| user_id      | BIGINT       | FOREIGN KEY, NOT NULL       | ユーザー ID                            |
| title        | VARCHAR(255) | NOT NULL                    | タスクタイトル                         |
| description  | TEXT         | NULL                        | タスク説明                             |
| status       | TINYINT      | DEFAULT 0                   | ステータス（0:未着手,1:進行中,2:完了） |
| due_date     | DATETIME     | NULL                        | 期限日時                               |
| completed_at | DATETIME     | NULL                        | 完了日時                               |
| created_by   | BIGINT       | FOREIGN KEY                 | 作成者 ID                              |
| updated_by   | BIGINT       | FOREIGN KEY                 | 更新者 ID                              |
| created_at   | TIMESTAMP    | NULL                        | 作成日時                               |
| updated_at   | TIMESTAMP    | NULL                        | 更新日時                               |
| deleted_at   | TIMESTAMP    | NULL                        | 削除日時（ソフトデリート）             |

### 2.3 インデックス設計

```sql
-- usersテーブル
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_deleted_at ON users(deleted_at);

-- tasksテーブル
CREATE INDEX idx_tasks_user_id ON tasks(user_id);
CREATE INDEX idx_tasks_status ON tasks(status);
CREATE INDEX idx_tasks_due_date ON tasks(due_date);
CREATE INDEX idx_tasks_deleted_at ON tasks(deleted_at);
CREATE INDEX idx_tasks_user_status ON tasks(user_id, status);
```

## 3. API 設計

### 3.1 認証 API

#### 3.1.1 ユーザー登録

```
POST /api/auth/register
Content-Type: application/json

Request Body:
{
  "name": "string",
  "email": "string",
  "password": "string"
}

Response:
{
  "success": true,
  "data": {
    "user": {
      "id": 1,
      "name": "string",
      "email": "string"
    },
    "token": "string"
  }
}
```

#### 3.1.2 ログイン

```
POST /api/auth/login
Content-Type: application/json

Request Body:
{
  "email": "string",
  "password": "string"
}

Response:
{
  "success": true,
  "data": {
    "user": {
      "id": 1,
      "name": "string",
      "email": "string"
    },
    "token": "string"
  }
}
```

### 3.2 タスク API

#### 3.2.1 タスク一覧取得

```
GET /api/tasks?page=1&per_page=10&status=0&user_id=1&keyword=test&sort_by=due_date&sort_direction=asc
Authorization: Bearer {token}

Response:
{
  "success": true,
  "data": {
    "current_page": 1,
    "data": [
      {
        "id": 1,
        "title": "string",
        "description": "string",
        "status": "pending",
        "due_date": "2024-01-01T00:00:00Z",
        "completed_at": null,
        "created_at": "2024-01-01T00:00:00Z",
        "updated_at": "2024-01-01T00:00:00Z"
      }
    ],
    "first_page_url": "string",
    "from": 1,
    "last_page": 1,
    "last_page_url": "string",
    "links": [],
    "next_page_url": null,
    "path": "string",
    "per_page": 10,
    "prev_page_url": null,
    "to": 1,
    "total": 1
  }
}
```

#### 3.2.2 タスク作成

```
POST /api/tasks
Authorization: Bearer {token}
Content-Type: application/json

Request Body:
{
  "title": "string",
  "description": "string",
  "status": 0,
  "due_date": "2024-01-01T00:00:00Z"
}

Response:
{
  "success": true,
  "data": {
    "id": 1,
    "title": "string",
    "description": "string",
    "status": "pending",
    "due_date": "2024-01-01T00:00:00Z",
    "completed_at": null,
    "created_at": "2024-01-01T00:00:00Z",
    "updated_at": "2024-01-01T00:00:00Z"
  }
}
```

## 4. セキュリティ設計

### 4.1 認証・認可

-   **認証方式**: JWT（JSON Web Token）
-   **トークン有効期限**: 24 時間
-   **リフレッシュトークン**: 7 日間
-   **認可**: ユーザーは自分のリソースのみアクセス可能

### 4.2 データ保護

-   **パスワード**: bcrypt によるハッシュ化
-   **入力検証**: Laravel Form Request による検証
-   **SQL インジェクション対策**: Eloquent ORM 使用
-   **XSS 対策**: 出力エスケープ

### 4.3 通信セキュリティ

-   **HTTPS**: 全通信の暗号化
-   **CORS**: 適切な CORS 設定
-   **レート制限**: API 呼び出し頻度制限

## 5. パフォーマンス設計

### 5.1 データベース最適化

-   **インデックス**: 検索条件に応じたインデックス設定
-   **クエリ最適化**: N+1 問題の回避
-   **ページネーション**: 大量データの効率的な取得

### 5.2 キャッシュ戦略

-   **アプリケーションキャッシュ**: Redis 使用
-   **クエリキャッシュ**: 頻繁にアクセスされるデータのキャッシュ
-   **レスポンスキャッシュ**: API レスポンスのキャッシュ

### 5.3 非同期処理

-   **キュー**: 重い処理の非同期実行
-   **ジョブ**: バックグラウンド処理

## 6. エラーハンドリング設計

### 6.1 HTTP ステータスコード

| ステータスコード | 用途                 |
| ---------------- | -------------------- |
| 200              | 成功                 |
| 201              | 作成成功             |
| 400              | リクエストエラー     |
| 401              | 認証エラー           |
| 403              | 認可エラー           |
| 404              | リソース未発見       |
| 422              | バリデーションエラー |
| 500              | サーバーエラー       |

### 6.2 エラーレスポンス形式

```json
{
    "success": false,
    "message": "エラーメッセージ",
    "errors": {
        "field_name": ["バリデーションエラーメッセージ"]
    }
}
```

## 7. ログ設計

### 7.1 ログレベル

-   **ERROR**: システムエラー
-   **WARN**: 警告
-   **INFO**: 一般的な情報
-   **DEBUG**: デバッグ情報

### 7.2 ログ出力項目

-   **アクセスログ**: リクエスト情報、レスポンス情報
-   **エラーログ**: エラー詳細、スタックトレース
-   **セキュリティログ**: 認証失敗、不正アクセス

## 8. 監視設計

### 8.1 メトリクス

-   **レスポンス時間**: API 応答時間
-   **スループット**: リクエスト処理数
-   **エラー率**: エラー発生率
-   **リソース使用率**: CPU、メモリ使用率

### 8.2 アラート設定

-   **レスポンス時間**: 500ms 超過
-   **エラー率**: 5%超過
-   **リソース使用率**: 80%超過

## 9. デプロイ設計

### 9.1 CI/CD パイプライン

```
Git Push → GitHub Actions → Test → Build → Deploy
```

### 9.2 環境構成

-   **開発環境**: ローカル開発
-   **ステージング環境**: 結合テスト
-   **本番環境**: サービス提供

### 9.3 コンテナ化

-   **Docker**: アプリケーションのコンテナ化
-   **Docker Compose**: 開発環境の構築
-   **Kubernetes**: 本番環境のオーケストレーション

## 10. バックアップ・復旧設計

### 10.1 バックアップ戦略

-   **データベース**: 日次フルバックアップ
-   **アプリケーション**: コードリポジトリ
-   **設定ファイル**: バージョン管理

### 10.2 復旧手順

-   **RTO**: 4 時間以内
-   **RPO**: 24 時間以内
-   **復旧テスト**: 月次実施
